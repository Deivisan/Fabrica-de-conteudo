version: '3.8'

services:
  mcp-platform:
    build: .
    container_name: mcp-platform
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      # Configurações do Playwright para automação gratuita
      - PLAYWRIGHT_HEADLESS=true
      - PLAYWRIGHT_USER_DATA_DIR=/app/browser-data
      - PLAYWRIGHT_SLOW_MO=50
      - PLAYWRIGHT_TIMEOUT=60000
      # Variáveis de ambiente para APIs (opcional)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GOOGLE_AI_API_KEY=${GOOGLE_AI_API_KEY:-}
      - GROK_API_KEY=${GROK_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      # Credenciais para redes sociais
      - INSTAGRAM_USERNAME=${INSTAGRAM_USERNAME:-}
      - INSTAGRAM_PASSWORD=${INSTAGRAM_PASSWORD:-}
      - GOOGLE_EMAIL=${GOOGLE_EMAIL:-}
      - GOOGLE_PASSWORD=${GOOGLE_PASSWORD:-}
      - TWITTER_USERNAME=${TWITTER_USERNAME:-}
      - TWITTER_PASSWORD=${TWITTER_PASSWORD:-}
    volumes:
      # Montar diretórios para estratégias, assets e logs
      - ./strategies:/app/strategies
      - ./assets:/app/assets
      - ./output:/app/output
      - ./logs:/app/logs
      # IMPORTANTE: Persistir dados do navegador para manter sessões
      - ./browser-data:/app/browser-data
      # Opcional: Para desenvolvimento
      # - .:/app
    ports:
      - "3000:3000"
      - "3001:3001"
    # Configuração para Playwright
    shm_size: 2gb  # Necessário para o Playwright
    security_opt:
      - no-new-privileges:true
    # Capacidades necessárias para Playwright
    cap_add:
      - SYS_ADMIN
    networks:
      - mcp-network

  # Serviço opcional para configuração de sessões (modo interativo)
  mcp-setup:
    build: .
    container_name: mcp-setup
    profiles:
      - setup
    environment:
      - PLAYWRIGHT_HEADLESS=false
      - PLAYWRIGHT_USER_DATA_DIR=/app/browser-data
    volumes:
      - ./browser-data:/app/browser-data
      - ./assets:/app/assets
    # Para modo interativo com display
    # Descomente as linhas abaixo se estiver em Linux com X11
    # environment:
    #   - DISPLAY=${DISPLAY}
    # volumes:
    #   - /tmp/.X11-unix:/tmp/.X11-unix
    shm_size: 2gb
    command: node treinamento/index.js --setup
    networks:
      - mcp-network

  markitdown:
    image: mcp/markitdown:latest
    container_name: markitdown-mcp
    restart: unless-stopped
    ports:
      - "3001:3001"
    volumes:
      - ./workdir:/workdir
    networks:
      - mcp-network

networks:
  mcp-network:
    driver: bridge